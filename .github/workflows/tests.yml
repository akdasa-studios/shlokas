name: Tests
on: push


env:
  REGISTRY: ghcr.io


jobs:

  # ---------------------------------------------------------------------------- #
  #                                Compile sources                               #
  # ---------------------------------------------------------------------------- #

  compile:
    name: 💾 Compile
    permissions:
      packages: read
    runs-on: ubuntu-latest
    steps:
    - name: 📥 Checkout
      uses: actions/checkout@v3

    - name: 📦 [Node] Install
      uses: actions/setup-node@v3
      with:
        node-version: 18

    - name: 📦 [Node] Cache packages
      uses: actions/cache@v3
      id: cache-primes
      with:
        path: node_modules
        key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}

    - name: 📦 [Node] Install packages
      if: steps.cache-primes.outputs.cache-hit != 'true'
      run: npm ci --audit=false
      env:
        NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: 🏇 [Shlokas] Compile
      run: npm run build:testing
      env:
        NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: 🚚  [Artifacts] Upload
      uses: actions/upload-artifact@v3.1.2
      with:
        name: shlokas-compiled
        path: dist/
        retention-days: 1


  # ---------------------------------------------------------------------------- #
  #                                Build container                               #
  # ---------------------------------------------------------------------------- #

  build:
    name: 🏗️ Build
    needs: compile
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v3

      - name: 📥 Download compiled
        uses: actions/download-artifact@v3
        with:
          name: shlokas-compiled
          path: dist/

      - name: Setup Docker buildx
        uses: docker/setup-buildx-action@v2.5.0

      - name: 🐳 Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          tags: shlokas:latest
          outputs: type=docker,dest=/tmp/shlokas-container.tar
          build-args: |
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            ENVIRONMENT: testing


      - name: 🐳 Upload artifact
        uses: actions/upload-artifact@v3.1.2
        with:
          name: shlokas-container
          path: /tmp/shlokas-container.tar

  e2e:
    name: 🚀 E2E
    needs: build
    strategy:
      matrix:
        project: [ 'Mobile Chrome', 'Mobile Safari' ]
    permissions:
      packages: read
    timeout-minutes: 30
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v3
        with:
          repository: 'akdasa-studios/shlokas-server'

      - name: 🐳 Download artifact
        uses: actions/download-artifact@v3
        with:
          name: shlokas-container
          path: /tmp

      - name: 🐳 Load Docker image
        run: |
          docker load --input /tmp/shlokas-container.tar
          docker image ls -a

      # - name: Environment
      #   uses: isbang/compose-action@v1.4.1
      #   with:
      #     compose-file: |
      #       docker-compose.yml
      #       docker-compose.testing.yml
      #       docker-compose.testing.ci.yml
      #     down-flags: "--volumes"

      - name: 🐳 Start server
        run: ./shlokas.run.sh testing
        shell: bash

      - name: 🧪 Testing
        uses: addnab/docker-run-action@v3
        with:
          image: ghcr.io/akdasa-studios/shlokas-e2e:latest
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          options: |
            -e CI=1
            -e SHLOKAS_URL=http://shlokas
            -e MAIL_URL=http://mail:1080
            -v ${{ github.workspace }}/output:/e2e/output
            --network shlokas
          shell: bash
          run: |
            npm i
            npx playwright test --project="${{ matrix.project }}"

      - name: 🚚  [Artifacts] Upload
        if: ${{ failure() }}
        uses: actions/upload-artifact@v3.1.2
        with:
          name: e2e-${{ matrix.project }}
          path: output/
          retention-days: 5
